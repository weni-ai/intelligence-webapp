# syntax = docker/dockerfile:1

ARG NODE_VERSION="18.19.1"
ARG BASE_VERSION="alpine3.19"
ARG OLD_IMAGE="intelligence-webapp:latest"
ARG KEEP_DAYS=60

FROM node:${NODE_VERSION}-${BASE_VERSION} AS builder

WORKDIR /app

ARG VITE_BILLING_API_BASE_URL
ARG VITE_INTELLIGENCE_LEGACY_URL
ARG VITE_API_BASE_URL
ARG VITE_NEXUS_API_BASE_URL
ARG VITE_NEXUS_WEBSOCKET_BASE_URL
ARG VITE_FLOWS_API_BASE_URL
ARG VITE_VERSION
ARG VITE_BOTHUB_NLP_BASE_URL
ARG VITE_VERSION_ENABLED
ARG VITE_BOTHUB_WEBAPP_USE_SENTRY
ARG VITE_SUPPORTED_LANGUAGES
ARG VITE_BOTHUB_WEBAPP_SENTRY
ARG VITE_OPTIONS_WENIGPT
ARG VITE_SENTRY_ENVIRONMENT
ARG VITE_ORGS_CAN_CREATE_CONTENT_AI
ARG VITE_FF_ORGS_WITH_AGENTS_TEAM
ARG VITE_FF_PROJECTS_WITH_AGENTS_TEAM
ARG VITE_GROWTHBOOK_CLIENT_KEY
ARG VITE_GROWTHBOOK_API_HOST
ARG VITE_HOTJAR_ID
ARG VITE_TEMPLATE_LINK_FLOW_EDITOR
ARG VITE_KEYCLOAK_SERVER
ARG VITE_KEYCLOAK_REALM
ARG VITE_USERS_CAN_MONITORING

ENV VITE_BILLING_API_BASE_URL=${VITE_BILLING_API_BASE_URL}
ENV VITE_INTELLIGENCE_LEGACY_URL=${VITE_INTELLIGENCE_LEGACY_URL}
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV VITE_NEXUS_API_BASE_URL=${VITE_NEXUS_API_BASE_URL}
ENV VITE_NEXUS_WEBSOCKET_BASE_URL=${VITE_NEXUS_WEBSOCKET_BASE_URL}
ENV VITE_FLOWS_API_BASE_URL=${VITE_FLOWS_API_BASE_URL}
ENV VITE_VERSION=${VITE_VERSION}
ENV VITE_BOTHUB_NLP_BASE_URL=${VITE_BOTHUB_NLP_BASE_URL}
ENV VITE_VERSION_ENABLED=${VITE_VERSION_ENABLED}
ENV VITE_BOTHUB_WEBAPP_USE_SENTRY=${VITE_BOTHUB_WEBAPP_USE_SENTRY}
ENV VITE_SUPPORTED_LANGUAGES=${VITE_SUPPORTED_LANGUAGES}
ENV VITE_BOTHUB_WEBAPP_SENTRY=${VITE_BOTHUB_WEBAPP_SENTRY}
ENV VITE_OPTIONS_WENIGPT=${VITE_OPTIONS_WENIGPT}
ENV VITE_SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
ENV VITE_ORGS_CAN_CREATE_CONTENT_AI=${VITE_ORGS_CAN_CREATE_CONTENT_AI}
ENV VITE_FF_ORGS_WITH_AGENTS_TEAM=${VITE_FF_ORGS_WITH_AGENTS_TEAM}
ENV VITE_FF_PROJECTS_WITH_AGENTS_TEAM=${VITE_FF_PROJECTS_WITH_AGENTS_TEAM}
ENV VITE_GROWTHBOOK_CLIENT_KEY=${VITE_GROWTHBOOK_CLIENT_KEY}
ENV VITE_GROWTHBOOK_API_HOST=${VITE_GROWTHBOOK_API_HOST}
ENV VITE_HOTJAR_ID=${VITE_HOTJAR_ID}
ENV VITE_TEMPLATE_LINK_FLOW_EDITOR=${VITE_TEMPLATE_LINK_FLOW_EDITOR}
ENV VITE_KEYCLOAK_SERVER=${VITE_KEYCLOAK_SERVER}
ENV VITE_KEYCLOAK_REALM=${VITE_KEYCLOAK_REALM}
ENV VITE_USERS_CAN_MONITORING=${VITE_USERS_CAN_MONITORING}

RUN apk add --no-cache git

COPY package.json yarn.lock ./

RUN --mount=type=cache,target=/root/.yarn YARN_CACHE_FOLDER=/root/.yarn yarn install

COPY . ./

RUN yarn build

RUN ls /app
RUN ls /app/dist/assets

FROM ${OLD_IMAGE} AS old_css

FROM nginxinc/nginx-unprivileged:1.25-alpine

ARG KEEP_DAYS

COPY --chown=nginx:nginx docker/nginx.conf /etc/nginx/nginx.conf
COPY --chown=nginx:nginx docker/headers /usr/share/nginx/html/headers
COPY --chown=nginx:nginx docker/file_handler.sh /
COPY docker/docker-entrypoint.sh /
COPY --from=builder --chown=nginx:nginx /app/dist /usr/share/nginx/html/bothub-webapp/
COPY --from=old_css --chown=nginx:nginx /usr/share/nginx/html/bothub-webapp/assets/all.tx[t] /usr/share/nginx/html/bothub-webapp/assets/*.css /usr/share/nginx/html/bothub-webapp/assets/

RUN cd /usr/share/nginx/html/bothub-webapp/ \
    && ln -s /tmp/config.js \
    && /file_handler.sh css

EXPOSE 8080

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["nginx", "-g", "daemon off;"]
