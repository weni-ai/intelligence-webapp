# syntax = docker/dockerfile:1

ARG NODE_VERSION="18.19.1"
ARG BASE_VERSION="alpine3.19"
ARG OLD_IMAGE="intelligence-webapp:latest"
ARG KEEP_DAYS=60

FROM node:${NODE_VERSION}-${BASE_VERSION} AS builder

WORKDIR /app

ARG VITE_BILLING_API_BASE_URL
ARG VITE_API_BASE_URL
ARG VITE_NEXUS_API_BASE_URL
ARG VITE_NEXUS_WEBSOCKET_BASE_URL
ARG VITE_FLOWS_API_BASE_URL
ARG VITE_VERSION
ARG VITE_BOTHUB_NLP_BASE_URL
ARG VITE_BOTHUB_WEBAPP_BASE_URL
ARG VITE_VERSION_ENABLED
ARG VITE_BOTHUB_WEBAPP_USE_SENTRY
ARG VITE_SUPPORTED_LANGUAGES
ARG VITE_BOTHUB_WEBAPP_USE_HOTJAR
ARG VITE_BOTHUB_WEBAPP_LIGHTHOUSE_KEY
ARG VITE_BOTHUB_WEBAPP_LIGHTHOUSE_ALGORITHM_ARTICLE_ID
ARG VITE_BOTHUB_WEBAPP_PAYMENT_ENABLED
ARG VITE_BOTHUB_WEBAPP_TUTORIAL_ENABLED
ARG VITE_BOTHUB_WEBAPP_HOTJAR_ID
ARG VITE_MAILCHIMP_LOGIN
ARG VITE_MAILCHIMP_DATACENTER
ARG VITE_BOTHUB_WEBAPP_SENTRY
ARG VITE_MAILCHIMP_DATACENTER
ARG VITE_MAILCHIMP_USER_ID
ARG VITE_MAILCHIMP_LIST_ID
ARG VITE_RECAPTCHA_TOKEN
ARG VITE_HELPHERO_ID
ARG VITE_HELPHERO_TOUR
ARG VITE_QA_FLOW_CHANNEL
ARG VITE_LOGROCKET_ID
ARG VITE_LOGROCKET_PARENT_DOMAIN
ARG VITE_OPTIONS_WENIGPT
ARG VITE_SENTRY_ENVIRONMENT
ARG VITE_ORGS_CAN_CREATE_CONTENT_AI
ARG VITE_FF_ORGS_WITH_AGENTS_TEAM
ARG VITE_FF_PROJECTS_WITH_AGENTS_TEAM

ENV VITE_BILLING_API_BASE_URL=${VITE_BILLING_API_BASE_URL}
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV VITE_NEXUS_API_BASE_URL=${VITE_NEXUS_API_BASE_URL}
ENV VITE_NEXUS_WEBSOCKET_BASE_URL=${VITE_NEXUS_WEBSOCKET_BASE_URL}
ENV VITE_FLOWS_API_BASE_URL=${VITE_FLOWS_API_BASE_URL}
ENV VITE_VERSION=${VITE_VERSION}
ENV VITE_BOTHUB_NLP_BASE_URL=${VITE_BOTHUB_NLP_BASE_URL}
ENV VITE_BOTHUB_WEBAPP_BASE_URL=${VITE_BOTHUB_WEBAPP_BASE_URL}
ENV VITE_VERSION_ENABLED=${VITE_VERSION_ENABLED}
ENV VITE_BOTHUB_WEBAPP_USE_SENTRY=${VITE_BOTHUB_WEBAPP_USE_SENTRY}
ENV VITE_SUPPORTED_LANGUAGES=${VITE_SUPPORTED_LANGUAGES}
ENV VITE_BOTHUB_WEBAPP_USE_HOTJAR=${VITE_BOTHUB_WEBAPP_USE_HOTJAR}
ENV VITE_BOTHUB_WEBAPP_LIGHTHOUSE_KEY=${VITE_BOTHUB_WEBAPP_LIGHTHOUSE_KEY}
ENV VITE_BOTHUB_WEBAPP_LIGHTHOUSE_ALGORITHM_ARTICLE_ID=${VITE_BOTHUB_WEBAPP_LIGHTHOUSE_ALGORITHM_ARTICLE_ID}
ENV VITE_BOTHUB_WEBAPP_PAYMENT_ENABLED=${VITE_BOTHUB_WEBAPP_PAYMENT_ENABLED}
ENV VITE_BOTHUB_WEBAPP_TUTORIAL_ENABLED=${VITE_BOTHUB_WEBAPP_TUTORIAL_ENABLED}
ENV VITE_BOTHUB_WEBAPP_HOTJAR_ID=${VITE_BOTHUB_WEBAPP_HOTJAR_ID}
ENV VITE_MAILCHIMP_LOGIN=${VITE_MAILCHIMP_LOGIN}
ENV VITE_MAILCHIMP_DATACENTER=${VITE_MAILCHIMP_DATACENTER}
ENV VITE_BOTHUB_WEBAPP_SENTRY=${VITE_BOTHUB_WEBAPP_SENTRY}
ENV VITE_MAILCHIMP_USER_ID=${VITE_MAILCHIMP_USER_ID}
ENV VITE_MAILCHIMP_LIST_ID=${VITE_MAILCHIMP_LIST_ID}
ENV VITE_RECAPTCHA_TOKEN=${VITE_RECAPTCHA_TOKEN}
ENV VITE_HELPHERO_ID=${VITE_HELPHERO_ID}
ENV VITE_HELPHERO_TOUR=${VITE_HELPHERO_TOUR}
ENV VITE_QA_FLOW_CHANNEL=${VITE_QA_FLOW_CHANNEL}
ENV VITE_LOGROCKET_ID=${VITE_LOGROCKET_ID}
ENV VITE_LOGROCKET_PARENT_DOMAIN=${VITE_LOGROCKET_PARENT_DOMAIN}
ENV VITE_OPTIONS_WENIGPT=${VITE_OPTIONS_WENIGPT}
ENV VITE_SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
ENV VITE_ORGS_CAN_CREATE_CONTENT_AI=${VITE_ORGS_CAN_CREATE_CONTENT_AI}
ENV VITE_FF_ORGS_WITH_AGENTS_TEAM=${VITE_FF_ORGS_WITH_AGENTS_TEAM}
ENV VITE_FF_PROJECTS_WITH_AGENTS_TEAM=${VITE_FF_PROJECTS_WITH_AGENTS_TEAM}

RUN apk add --no-cache git

COPY package.json yarn.lock ./

RUN --mount=type=cache,target=/root/.yarn YARN_CACHE_FOLDER=/root/.yarn yarn install

COPY . ./

RUN yarn build

RUN ls /app
RUN ls /app/dist/assets

FROM ${OLD_IMAGE} AS old_css

FROM nginxinc/nginx-unprivileged:1.25-alpine

ARG KEEP_DAYS

COPY --chown=nginx:nginx docker/nginx.conf /etc/nginx/nginx.conf
COPY --chown=nginx:nginx docker/headers /usr/share/nginx/html/headers
COPY --chown=nginx:nginx docker/file_handler.sh /
COPY docker/docker-entrypoint.sh /
COPY --from=builder --chown=nginx:nginx /app/dist /usr/share/nginx/html/bothub-webapp/
COPY --from=old_css --chown=nginx:nginx /usr/share/nginx/html/bothub-webapp/assets/all.tx[t] /usr/share/nginx/html/bothub-webapp/assets/*.css /usr/share/nginx/html/bothub-webapp/assets/

RUN cd /usr/share/nginx/html/bothub-webapp/ \
    && ln -s /tmp/config.js \
    && /file_handler.sh css

EXPOSE 8080

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["nginx", "-g", "daemon off;"]
